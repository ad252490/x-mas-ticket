<! DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Ticket - EKINTABULI</title>
    <link href="https://fonts. googleapis.com/css2?family=Playfair+Display:wght@700&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: white;
        }
        
        .container {
            max-width: 450px;
            width: 100%;
        }
        
        .card {
            background: rgba(26, 26, 46, 0.95);
            border-radius: 20px;
            padding: 30px;
            border: 2px solid rgba(212, 175, 55, 0. 3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            text-align: center;
        }
        
        .logo {
            font-family: 'Playfair Display', serif;
            font-size: 32px;
            color: #D4AF37;
            margin-bottom: 5px;
        }
        
        .subtitle {
            color: #888;
            font-size: 14px;
            margin-bottom: 30px;
        }
        
        .status-icon {
            font-size: 80px;
            margin: 20px 0;
        }
        
        .status-text {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        . status-valid { color: #28a745; }
        .status-invalid { color: #dc3545; }
        . status-used { color: #fd7e14; }
        .status-checking { color: #17a2b8; }
        
        .ticket-info {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0. 1);
        }
        
        . info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            color: #888;
            font-size: 12px;
        }
        
        .info-value {
            font-weight: 600;
            color: #D4AF37;
        }
        
        .message {
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 14px;
        }
        
        .message-success {
            background: rgba(40, 167, 69, 0. 2);
            border: 1px solid #28a745;
            color: #28a745;
        }
        
        .message-error {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
            color: #dc3545;
        }
        
        . message-warning {
            background: rgba(253, 126, 20, 0.2);
            border: 1px solid #fd7e14;
            color: #fd7e14;
        }
        
        .gate-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(212, 175, 55, 0.2);
        }
        
        .gate-title {
            color: #888;
            font-size: 12px;
            margin-bottom: 15px;
        }
        
        . pin-input {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        . pin-input input {
            width: 50px;
            height: 50px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0. 3);
            color: white;
        }
        
        .pin-input input:focus {
            outline: none;
            border-color: #D4AF37;
        }
        
        .btn {
            padding: 15px 30px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #D4AF37, #8B4513);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(212, 175, 55, 0. 4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .footer {
            margin-top: 20px;
            font-size: 11px;
            color: #666;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(212, 175, 55, 0.2);
            border-top-color: #D4AF37;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 30px auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="logo">üëë EKINTABULI</div>
            <div class="subtitle">Kya Christmas 2025 - Ticket Verification</div>
            
            <div id="content">
                <div class="spinner"></div>
                <p class="status-text status-checking">Verifying ticket...</p>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9. 22.0/firebase-app-compat.js"></script>
    <script src="https://www. gstatic.com/firebasejs/9.22.0/firebase-firestore-compat. js"></script>
    <script src="../shared/firebase-config.js"></script>
    <script>
        const CONFIG = {
            secretKey: 'EKINTABULI-2025-XMAS-SECRET',
            gatePin: '2025' // PIN for gate staff to validate
        };
        
        let currentTicket = null;
        let ticketData = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const encryptedCode = urlParams.get('t');
            
            if (! encryptedCode) {
                showError('No ticket code provided', 'Please scan a valid ticket QR code.');
                return;
            }
            
            verifyTicket(encryptedCode);
        });
        
        function decryptTicketCode(encrypted) {
            try {
                // Add padding if needed
                let padded = encrypted;
                while (padded.length % 4 !== 0) {
                    padded += '=';
                }
                const decoded = atob(padded);
                const parts = decoded.split('|');
                return parts[0]; // Return ticket ID
            } catch (e) {
                console.error('Decryption error:', e);
                return null;
            }
        }
        
        async function verifyTicket(encryptedCode) {
            const ticketId = decryptTicketCode(encryptedCode);
            
            if (!ticketId) {
                showError('Invalid Ticket', 'This ticket code is not valid or has been tampered with.');
                return;
            }
            
            currentTicket = ticketId;
            
            // Try to find ticket in local storage first
            const localTickets = JSON.parse(localStorage.getItem('ekintabuli_tickets') || '[]');
            ticketData = localTickets.find(t => t.ticketId === ticketId);
            
            if (ticketData) {
                displayTicketStatus(ticketData);
            } else if (typeof db !== 'undefined' && db) {
                // Try Firebase
                try {
                    const doc = await db.collection('tickets').doc(ticketId).get();
                    if (doc.exists) {
                        ticketData = { id: doc.id, ... doc.data() };
                        displayTicketStatus(ticketData);
                    } else {
                        showError('Ticket Not Found', 'This ticket does not exist in our system.');
                    }
                } catch (e) {
                    showError('Verification Failed', 'Could not verify ticket. Please try again.');
                }
            } else {
                showError('Ticket Not Found', 'This ticket does not exist in our system.');
            }
        }
        
        function displayTicketStatus(ticket) {
            const content = document.getElementById('content');
            
            if (ticket. status === 'USED') {
                content.innerHTML = `
                    <div class="status-icon">‚ö†Ô∏è</div>
                    <p class="status-text status-used">ALREADY USED</p>
                    
                    <div class="ticket-info">
                        <div class="info-row">
                            <span class="info-label">Ticket ID</span>
                            <span class="info-value">${ticket.ticketId}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Used At</span>
                            <span class="info-value">${formatDate(ticket.usedAt)}</span>
                        </div>
                    </div>
                    
                    <div class="message message-warning">
                        ‚ö†Ô∏è This ticket has already been scanned and used for entry.  It cannot be used again.
                    </div>
                    
                    <div class="footer">
                        üîí EKINTABULI Kya Christmas 2025
                    </div>
                `;
            } else {
                // Valid ticket - show verification page
                content. innerHTML = `
                    <div class="status-icon">‚úÖ</div>
                    <p class="status-text status-valid">VALID TICKET</p>
                    
                    <div class="ticket-info">
                        <div class="info-row">
                            <span class="info-label">Ticket ID</span>
                            <span class="info-value">${ticket. ticketId}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Event</span>
                            <span class="info-value">EKINTABULI Kya Christmas</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Date</span>
                            <span class="info-value">25th December 2025</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Venue</span>
                            <span class="info-value">Club Missouka</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Status</span>
                            <span class="info-value" style="color: #28a745;">‚úì Ready for Entry</span>
                        </div>
                    </div>
                    
                    <div class="message message-success">
                        ‚úÖ This ticket is authentic and valid for entry. 
                    </div>
                    
                    <div class="gate-section">
                        <p class="gate-title">üö™ GATE STAFF ONLY - Enter PIN to validate entry</p>
                        <div class="pin-input">
                            <input type="password" maxlength="1" id="pin1" oninput="moveToNext(this, 'pin2')">
                            <input type="password" maxlength="1" id="pin2" oninput="moveToNext(this, 'pin3')">
                            <input type="password" maxlength="1" id="pin3" oninput="moveToNext(this, 'pin4')">
                            <input type="password" maxlength="1" id="pin4" oninput="checkPin()">
                        </div>
                        <button class="btn btn-primary" id="validateBtn" onclick="validateEntry()" disabled>
                            üö™ Validate Entry
                        </button>
                    </div>
                    
                    <div class="footer">
                        üîí Customers: This page confirms your ticket is valid. <br>
                        Only gate staff can mark entry with the PIN.
                    </div>
                `;
            }
        }
        
        function moveToNext(current, nextId) {
            if (current.value. length === 1) {
                const next = document.getElementById(nextId);
                if (next) next.focus();
            }
        }
        
        function checkPin() {
            const pin = document.getElementById('pin1').value +
                       document.getElementById('pin2').value +
                       document.getElementById('pin3').value +
                       document.getElementById('pin4').value;
            
            document.getElementById('validateBtn').disabled = pin. length !== 4;
        }
        
        async function validateEntry() {
            const pin = document.getElementById('pin1').value +
                       document.getElementById('pin2').value +
                       document.getElementById('pin3').value +
                       document. getElementById('pin4'). value;
            
            if (pin !== CONFIG.gatePin) {
                alert('‚ùå Invalid PIN!  Please try again.');
                // Clear PIN inputs
                document.getElementById('pin1').value = '';
                document. getElementById('pin2'). value = '';
                document.getElementById('pin3').value = '';
                document.getElementById('pin4').value = '';
                document.getElementById('pin1').focus();
                document.getElementById('validateBtn').disabled = true;
                return;
            }
            
            // Mark ticket as used
            const btn = document.getElementById('validateBtn');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Processing...';
            
            try {
                // Update local storage
                const localTickets = JSON.parse(localStorage. getItem('ekintabuli_tickets') || '[]');
                const ticketIndex = localTickets.findIndex(t => t.ticketId === currentTicket);
                
                if (ticketIndex !== -1) {
                    localTickets[ticketIndex].status = 'USED';
                    localTickets[ticketIndex].usedAt = new Date().toISOString();
                    localStorage.setItem('ekintabuli_tickets', JSON. stringify(localTickets));
                }
                
                // Update Firebase if available
                if (typeof db !== 'undefined' && db) {
                    await db.collection('tickets').doc(currentTicket).update({
                        status: 'USED',
                        usedAt: firebase.firestore. FieldValue.serverTimestamp()
                    });
                    
                    // Log scan
                    await db.collection('scanLogs').add({
                        ticketId: currentTicket,
                        result: 'VALID',
                        timestamp: firebase.firestore. FieldValue.serverTimestamp()
                    });
                }
                
                // Show success
                const content = document.getElementById('content');
                content.innerHTML = `
                    <div class="status-icon">üéâ</div>
                    <p class="status-text status-valid">ENTRY GRANTED!</p>
                    
                    <div class="ticket-info">
                        <div class="info-row">
                            <span class="info-label">Ticket ID</span>
                            <span class="info-value">${currentTicket}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Entry Time</span>
                            <span class="info-value">${new Date().toLocaleTimeString()}</span>
                        </div>
                    </div>
                    
                    <div class="message message-success">
                        üéâ Welcome to EKINTABULI Kya Christmas 2025!  Enjoy the party!
                    </div>
                    
                    <div class="footer">
                        ‚úÖ This ticket has been validated and cannot be used again. 
                    </div>
                `;
                
            } catch (error) {
                console. error('Validation error:', error);
                alert('Error validating ticket. Please try again.');
                btn.disabled = false;
                btn.innerHTML = 'üö™ Validate Entry';
            }
        }
        
        function showError(title, message) {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="status-icon">‚ùå</div>
                <p class="status-text status-invalid">${title}</p>
                <div class="message message-error">${message}</div>
                <div class="footer">
                    üîí EKINTABULI Kya Christmas 2025<br>
                    If you believe this is an error, please contact event organizers.
                </div>
            `;
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return 'Unknown';
            const date = new Date(dateStr);
            return date.toLocaleString();
        }
    </script>
</body>
</html>
